# Perbaikan Masalah Timezone Waktu Visitasi

## Masalah yang Ditemukan

Ketika admin mengupdate waktu visitasi menjadi "17 Juli 2025 08:00", waktu yang tersimpan di database menjadi "2025-07-18 01:00:00.000" (UTC). Ini terjadi karena masalah konversi timezone yang tidak konsisten.

## Analisis Masalah

### 1. Input dari Admin
- **Waktu yang dimasukkan**: 17 Juli 2025 08:00 (WIB/Asia/Jakarta)
- **Format input**: `datetime-local` HTML input

### 2. Kode yang Bermasalah (Sebelum Perbaikan)
```php
// Di PenugasanAuditorController.php
$waktuVisitasi = \Carbon\Carbon::parse($request->waktu_visitasi, 'Asia/Jakarta')->utc();
```

### 3. Masalah yang Terjadi
- **Asia/Jakarta**: 17 Juli 2025 08:00
- **UTC**: Seharusnya 17 Juli 2025 01:00 (karena WIB = UTC+7)
- **Hasil di database**: 18 Juli 2025 01:00 (tidak sesuai)

## Solusi yang Diterapkan

### 1. Perbaikan di Backend (PenugasanAuditorController.php)

**Sebelum:**
```php
$waktuVisitasi = \Carbon\Carbon::parse($request->waktu_visitasi, 'Asia/Jakarta')->utc();
```

**Sesudah:**
```php
$waktuVisitasi = \Carbon\Carbon::createFromFormat('Y-m-d\TH:i', $request->waktu_visitasi, 'Asia/Jakarta')->utc();
```

### 2. Perbaikan di Frontend (penugasan_auditor/index.blade.php)

**Sebelum:**
```javascript
const date = new Date(assignments.waktu_visitasi);
const formattedDate = date.toISOString().slice(0, 16);
```

**Sesudah:**
```javascript
const date = new Date(assignments.waktu_visitasi);
// Adjust for timezone offset (UTC+7 for Asia/Jakarta)
const localDate = new Date(date.getTime() + (7 * 60 * 60 * 1000));
const formattedDate = localDate.toISOString().slice(0, 16);
```

### 3. Perbaikan di Validasi Waktu Visitasi (AuditorAuditController.php)

**Sebelum:**
```php
$scheduledTime = \Carbon\Carbon::parse($pengajuan->waktu);
$currentTime = \Carbon\Carbon::now();
```

**Sesudah:**
```php
// Parse UTC time from database and convert to Asia/Jakarta timezone for display
$scheduledTime = \Carbon\Carbon::parse($pengajuan->waktu)->setTimezone('Asia/Jakarta');
$currentTime = \Carbon\Carbon::now('Asia/Jakarta');
```

### 4. Perbaikan di Halaman Cetak/PDF

**Sebelum:**
```php
{{ \Carbon\Carbon::parse($pengajuanAmis->waktu)->format('H:i') }} WIB
```

**Sesudah:**
```php
{{ \Carbon\Carbon::parse($pengajuanAmis->waktu)->setTimezone('Asia/Jakarta')->format('H:i') }} WIB
```

## Penjelasan Teknis

### Mengapa Masalah Ini Terjadi?

1. **Input datetime-local**: Browser mengirim waktu dalam format UTC
2. **Carbon::parse()**: Tidak menangani timezone dengan benar untuk format datetime-local
3. **Konversi timezone**: Menggunakan `createFromFormat()` lebih akurat untuk format spesifik

### Mengapa Solusi Ini Bekerja?

1. **`createFromFormat()`**: Memastikan parsing yang akurat sesuai format input
2. **Timezone conversion**: Menggunakan `setTimezone()` untuk konversi yang konsisten
3. **Frontend adjustment**: Menambahkan offset timezone untuk display yang benar

## File yang Diperbaiki

1. `app/Http/Controllers/PenugasanAuditorController.php`
   - Method `savePenugasanAuditor()`
   - Method `updatePenugasanAuditor()`

2. `app/Http/Controllers/AuditorAuditController.php`
   - Method `checkVisitasiTimeValidation()`

3. `resources/views/penugasan_auditor/index.blade.php`
   - JavaScript untuk menampilkan waktu visitasi

4. `resources/views/cetak/daftar_pertanyaan.blade.php`
   - Template untuk cetak PDF

5. `resources/views/dataauditor/pdf/daftar_pertanyaan.blade.php`
   - Template untuk PDF auditor

## Testing

Setelah perbaikan, waktu visitasi seharusnya:
1. **Input**: 17 Juli 2025 08:00 (WIB)
2. **Database**: 2025-07-17 01:00:00.000 (UTC)
3. **Display**: 17 Juli 2025 08:00 (WIB)

## Catatan Penting

- Pastikan aplikasi menggunakan timezone `Asia/Jakarta` di konfigurasi
- Semua waktu disimpan dalam UTC di database
- Semua waktu ditampilkan dalam WIB (UTC+7) di frontend
- Gunakan `setTimezone('Asia/Jakarta')` untuk konversi dari UTC ke WIB
- Gunakan `utc()` untuk konversi dari WIB ke UTC 
