# Konfigurasi Nginx untuk Mengatasi Error 413

## üö® Masalah
Error 413 "Request Entity Too Large" terjadi di level nginx sebelum request sampai ke Laravel. Ini berarti konfigurasi nginx memblokir request yang lebih besar dari batas yang ditetapkan.

## üõ†Ô∏è Solusi

### 1. Update Konfigurasi Nginx

Tambahkan atau update konfigurasi berikut di file nginx:

```nginx
# Di dalam server block atau http block
client_max_body_size 500k;  # Sedikit lebih besar dari 450KB
client_body_buffer_size 128k;
client_body_timeout 60s;
client_header_timeout 60s;
```

### 2. Lokasi File Konfigurasi

Biasanya file konfigurasi nginx berada di:
- `/etc/nginx/nginx.conf` (main config)
- `/etc/nginx/sites-available/your-site` (site-specific config)
- `/etc/nginx/conf.d/your-site.conf` (alternative location)

### 3. Contoh Konfigurasi Lengkap

```nginx
server {
    listen 80;
    server_name sintamu.unib.ac.id;
    root /var/www/siami2025/public;
    index index.php;

    # Request size limits
    client_max_body_size 500k;
    client_body_buffer_size 128k;
    client_body_timeout 60s;
    client_header_timeout 60s;

    # Laravel configuration
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        
        # PHP limits
        fastcgi_read_timeout 300;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
}
```

### 4. Update PHP Configuration

Pastikan juga konfigurasi PHP mendukung:

```ini
# Di php.ini
post_max_size = 500K
upload_max_filesize = 500K
max_execution_time = 300
max_input_time = 300
memory_limit = 256M
```

### 5. Restart Services

Setelah mengupdate konfigurasi:

```bash
# Test konfigurasi nginx
sudo nginx -t

# Restart nginx
sudo systemctl restart nginx

# Restart PHP-FPM
sudo systemctl restart php8.1-fpm
```

### 6. Verifikasi

Test dengan mengirim request yang sebelumnya error 413:

```bash
# Test dengan curl
curl -X POST https://sintamu.unib.ac.id/auditee/submit-instrumen-ss/1 \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}' \
  -v
```

## üîç Troubleshooting

### Jika masih error 413:
1. Periksa log nginx: `sudo tail -f /var/log/nginx/error.log`
2. Pastikan konfigurasi sudah di-reload: `sudo nginx -s reload`
3. Periksa apakah ada konfigurasi lain yang override

### Jika error 502/503:
1. Periksa PHP-FPM status: `sudo systemctl status php8.1-fpm`
2. Periksa log PHP-FPM: `sudo tail -f /var/log/php8.1-fpm.log`

## üìù Catatan Penting

- `client_max_body_size` harus lebih besar dari batas Laravel (450KB)
- Set ke 500KB untuk memberikan buffer
- Restart nginx setelah perubahan konfigurasi
- Test dengan data yang sebelumnya error

## üöÄ Implementasi Frontend

Frontend sudah diupdate untuk:
1. **Validasi ukuran data** sebelum mengirim request
2. **Error handling yang lebih baik** untuk status 413
3. **Pesan error yang informatif** untuk user

Dengan kombinasi konfigurasi nginx dan validasi frontend, masalah 413 akan teratasi.
